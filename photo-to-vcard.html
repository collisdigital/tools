<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo to vCard Converter</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen p-4 md:p-8">

    <div class="max-w-3xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="text-center space-y-2 mb-8">
            <div class="inline-flex items-center justify-center p-3 bg-blue-100 rounded-full mb-2">
                <i data-lucide="scan-line" class="w-8 h-8 text-blue-600"></i>
            </div>
            <h1 class="text-3xl font-bold tracking-tight text-gray-900">Photo to vCard</h1>
            <p class="text-gray-500">Snap a photo of a business card to instantly create a contact.</p>
        </header>

        <!-- Configuration Panel -->
        <div class="glass-panel rounded-2xl p-6 shadow-sm space-y-4">
            <div class="flex items-center justify-between cursor-pointer" onclick="toggleSettings()">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="settings-2" class="w-5 h-5"></i> Settings
                </h2>
                <i id="settings-chevron" data-lucide="chevron-down" class="w-5 h-5 transition-transform"></i>
            </div>
            
            <div id="settings-content" class="hidden space-y-4 pt-4 border-t border-gray-100">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                    <input type="password" id="api-key" placeholder="Paste your AI Studio Key here" 
                           class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                           onchange="saveKey()">
                    <p class="text-xs text-gray-400 mt-1">Stored securely in your browser's LocalStorage.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                    <select id="model-select" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <optgroup label="Newest (Late 2025)">
                            <option value="gemini-3-pro-preview">Gemini 3.0 Pro Preview (Smartest)</option>
                            <option value="gemini-3-flash-preview">Gemini 3.0 Flash Preview (Fastest)</option>
                        </optgroup>
                        <optgroup label="Stable (v2.5)">
                            <option value="gemini-2.5-pro">Gemini 2.5 Pro (Stable High-Intel)</option>
                            <option value="gemini-2.5-flash" selected>Gemini 2.5 Flash (Recommended)</option>
                        </optgroup>
                        <optgroup label="Experimental">
                            <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                        </optgroup>
                        <optgroup label="Legacy (v1.5)">
                            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        </optgroup>
                    </select>
                </div>
            </div>
        </div>

        <!-- Upload Area -->
        <div id="drop-zone" class="relative group border-2 border-dashed border-gray-300 rounded-2xl p-10 text-center hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer">
            <input type="file" id="file-input" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
            <div class="space-y-3 pointer-events-none">
                <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto text-gray-400 group-hover:text-blue-500 transition-colors"></i>
                <div>
                    <p class="text-lg font-medium text-gray-700">Click to upload or drag & drop</p>
                    <p class="text-sm text-gray-500">Supports JPG, PNG, WEBP</p>
                </div>
            </div>
        </div>

        <!-- Preview & Loading -->
        <div id="processing-state" class="hidden text-center py-8">
            <div class="relative w-32 h-32 mx-auto mb-4 rounded-xl overflow-hidden shadow-lg border border-gray-200">
                <img id="image-preview" class="w-full h-full object-cover">
            </div>
            <div class="flex items-center justify-center gap-2 text-blue-600 font-medium animate-pulse">
                <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                <span>Extracting contact info...</span>
            </div>
        </div>

        <!-- Results List -->
        <div id="results-container" class="space-y-4"></div>

    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        Notification text
    </div>

    <script>
        // --- State Management ---
        const LS_KEY = 'gemini_vcard_key';
        let currentFileBase64 = null;
        let currentFileType = null;

        // --- Icons ---
        lucide.createIcons();

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem(LS_KEY);
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
            } else {
                toggleSettings(); // Open settings if no key found
            }
        });

        // --- UI Logic ---
        function toggleSettings() {
            const content = document.getElementById('settings-content');
            const chevron = document.getElementById('settings-chevron');
            content.classList.toggle('hidden');
            if (content.classList.contains('hidden')) {
                chevron.style.transform = 'rotate(0deg)';
            } else {
                chevron.style.transform = 'rotate(180deg)';
            }
        }

        function saveKey() {
            const key = document.getElementById('api-key').value.trim();
            if (key) {
                localStorage.setItem(LS_KEY, key);
                showToast('API Key saved successfully');
            }
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-xl transform transition-all duration-300 z-50 ${isError ? 'bg-red-600 text-white' : 'bg-gray-900 text-white'}`;
            toast.style.transform = 'translateY(0)';
            toast.style.opacity = '1';
            
            setTimeout(() => {
                toast.style.transform = 'translateY(5rem)';
                toast.style.opacity = '0';
            }, 3000);
        }

        // --- File Handling ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                currentFileType = file.type; // e.g., image/jpeg
                currentFileBase64 = dataUrl.split(',')[1]; // Remove "data:image/jpeg;base64,"
                
                // Show preview
                document.getElementById('image-preview').src = dataUrl;
                document.getElementById('processing-state').classList.remove('hidden');
                document.getElementById('drop-zone').classList.add('hidden');
                document.getElementById('results-container').innerHTML = ''; // Clear old results

                processImage();
            };
            reader.readAsDataURL(file);
        }

        // --- Gemini Integration ---
        async function processImage() {
            const apiKey = localStorage.getItem(LS_KEY);
            const model = document.getElementById('model-select').value;

            if (!apiKey) {
                showToast('Please enter your Gemini API Key in settings', true);
                resetUI();
                toggleSettings();
                return;
            }

            const prompt = `
            Analyze this image and identify all contact information visible. 
            For each person or entity found, create a JSON object with the following fields:
            - "fn": Full Name (string)
            - "org": Organization/Company (string)
            - "title": Job Title (string)
            - "tel": Phone number (string)
            - "email": Email address (string)
            - "url": Website URL (string)
            - "adr": Physical Address (string)

            Return ONLY a raw JSON array of objects. Do not wrap in markdown code blocks. 
            If a field is missing, leave it as an empty string. 
            Clean up phone numbers to be standard format if possible.
            `;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inline_data: {
                                mime_type: currentFileType,
                                data: currentFileBase64
                            }
                        }
                    ]
                }]
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                const data = await response.json();
                
                // Parse text
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("No text returned from Gemini");

                // Clean markdown if present
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();

                const contacts = JSON.parse(text);
                renderContacts(contacts);

            } catch (error) {
                console.error(error);
                showToast(`Error: ${error.message}`, true);
                resetUI();
            }
        }

        // --- Rendering & Logic ---
        function renderContacts(contacts) {
            const container = document.getElementById('results-container');
            document.getElementById('processing-state').classList.add('hidden');
            
            if (!Array.isArray(contacts) || contacts.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-8">No contacts found in image.</div>`;
                // Allow trying again
                const resetBtn = document.createElement('button');
                resetBtn.innerText = "Try Another Photo";
                resetBtn.className = "mt-4 text-blue-600 hover:underline";
                resetBtn.onclick = resetUI;
                container.appendChild(resetBtn);
                return;
            }

            container.innerHTML = '<h3 class="text-xl font-bold mb-4">Contacts Found</h3>';

            contacts.forEach((contact, index) => {
                const card = document.createElement('div');
                card.className = "glass-panel p-5 rounded-xl animate-fade-in flex flex-col md:flex-row md:items-center justify-between gap-4 group hover:border-blue-300 transition-colors";
                
                const initials = (contact.fn || contact.org || "?").substring(0, 2).toUpperCase();

                let detailsHtml = '';
                if (contact.email) detailsHtml += `<div class="flex items-center gap-2 text-sm text-gray-600"><i data-lucide="mail" class="w-4 h-4"></i> ${contact.email}</div>`;
                if (contact.tel) detailsHtml += `<div class="flex items-center gap-2 text-sm text-gray-600"><i data-lucide="phone" class="w-4 h-4"></i> ${contact.tel}</div>`;
                if (contact.org) detailsHtml += `<div class="flex items-center gap-2 text-sm text-gray-600"><i data-lucide="building-2" class="w-4 h-4"></i> ${contact.org}</div>`;

                card.innerHTML = `
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-lg shadow-md shrink-0">
                            ${initials}
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-gray-900">${contact.fn || "Unknown Contact"}</h4>
                            <p class="text-blue-600 text-sm font-medium mb-2">${contact.title || ""}</p>
                            <div class="space-y-1">
                                ${detailsHtml}
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 min-w-[140px]">
                        <button onclick="downloadVCard(${index})" class="flex items-center justify-center gap-2 bg-gray-900 hover:bg-black text-white px-4 py-2 rounded-lg text-sm font-medium transition-transform active:scale-95">
                            <i data-lucide="download" class="w-4 h-4"></i> Save Contact
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });

            // Store contacts for retrieval by index
            window.currentContacts = contacts;
            lucide.createIcons();

            // Add "Reset" button at bottom
            const resetContainer = document.createElement('div');
            resetContainer.className = "text-center pt-4";
            resetContainer.innerHTML = `<button onclick="resetUI()" class="text-gray-500 hover:text-gray-800 text-sm">Process another image</button>`;
            container.appendChild(resetContainer);
        }

        function resetUI() {
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('drop-zone').classList.remove('hidden');
            document.getElementById('processing-state').classList.add('hidden');
            document.getElementById('file-input').value = '';
            currentFileBase64 = null;
        }

        // --- vCard Generation ---
        function downloadVCard(index) {
            const contact = window.currentContacts[index];
            if (!contact) return;

            // Construct VCF string (Version 3.0 is widely compatible)
            let vcf = "BEGIN:VCARD\nVERSION:3.0\n";
            
            if (contact.fn) {
                vcf += `FN:${contact.fn}\n`;
                // Simple assumption: Last word is surname. Not perfect but standard for simple parsing.
                const names = contact.fn.split(' ');
                const givenName = names.slice(0, -1).join(' ');
                const familyName = names[names.length - 1] || '';
                vcf += `N:${familyName};${givenName};;;\n`;
            }
            
            if (contact.org) vcf += `ORG:${contact.org}\n`;
            if (contact.title) vcf += `TITLE:${contact.title}\n`;
            if (contact.tel) vcf += `TEL;TYPE=CELL:${contact.tel}\n`;
            if (contact.email) vcf += `EMAIL;TYPE=WORK:${contact.email}\n`;
            if (contact.url) vcf += `URL:${contact.url}\n`;
            if (contact.adr) vcf += `ADR;TYPE=WORK:;;${contact.adr};;;;\n`;
            
            vcf += "END:VCARD";

            // Create blob and download link
            const blob = new Blob([vcf], { type: 'text/vcard' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Clean filename
            const filename = (contact.fn || 'contact').replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.download = `${filename}.vcf`;
            a.href = url;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast('vCard downloaded!', false);
        }
    </script>
</body>
</html>
