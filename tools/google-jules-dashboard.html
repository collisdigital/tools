<!--
TOOL_OVERVIEW_START
{
  "name": "Google Jules Dashboard",
  "description": "A standalone HTML interface for the Google Jules API (v1alpha).",
  "functionality": {
    "session_management": "Lists all user sessions with status indicators (Active, Completed, Failed).",
    "activity_tracking": "Fetches and displays activity logs for sessions. Implements client-side pagination traversal to ensure the 'Most Recent 10' activities are displayed, even for long histories.",
    "rendering": "Specialized rendering for diverse activity types including User/Agent messages, Plans, Bash outputs, and Git patches.",
    "authentication": "Client-side API key management using localStorage."
  },
  "dependencies": ["Tailwind CSS (CDN)", "Google Fonts"],
  "last_updated": "2025-12-26"
}
TOOL_OVERVIEW_END
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Jules Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 84 91' fill='%23715cd7'%3E%3Cpath d='M41.824 4.80334C55.2044 4.80334 66.0631 15.6622 66.0632 29.0426C66.0632 29.7486 66.0299 30.4552 65.9626 31.1276C65.9963 31.4636 66.0632 31.7999 66.0632 32.1696V51.6354C66.0632 52.7782 65.7946 53.8539 65.324 54.8287V74.4957C65.324 76.6137 67.0722 78.3619 69.1902 78.3619C71.2421 78.3619 72.9471 76.7212 73.0515 74.693L73.0613 74.2985C73.1659 72.2704 74.8708 70.6295 76.9226 70.6295C79.0405 70.6296 80.7886 72.3443 80.7888 74.4957C80.7888 80.6143 76.0149 85.5898 69.9636 86.027C69.7283 86.0606 69.4591 86.0944 69.1902 86.0944C68.9212 86.0944 68.6857 86.0942 68.4167 86.027C62.399 85.6235 57.5916 80.648 57.5916 74.4957V59.0309H52.4138V74.3619C52.4136 76.4798 50.6991 78.2281 48.5476 78.2281C46.4298 78.228 44.6816 76.5133 44.6814 74.3619V59.0309H39.5046V74.3619C39.5044 76.4797 37.7898 78.228 35.6384 78.2281C33.5205 78.2281 31.7724 76.5134 31.7722 74.3619V59.0309H26.5945V74.4957C26.5945 80.6143 21.787 85.6234 15.7693 86.027C15.534 86.0606 15.2648 86.0944 14.9958 86.0944C14.7269 86.0944 14.4913 86.0942 14.2224 86.027C8.20468 85.6234 3.39722 80.648 3.39722 74.4957C3.3974 72.3779 5.14552 70.6295 7.26343 70.6295C9.38133 70.6295 11.1295 72.3443 11.1296 74.4957C11.1296 76.6137 12.8779 78.3619 14.9958 78.3619C17.1139 78.3619 18.8621 76.6137 18.8621 74.4957V55.8033C18.0554 54.6268 17.5848 53.1816 17.5847 51.6354V32.1696C17.5847 31.7999 17.6517 31.4636 17.6853 31.1276C17.6181 30.4216 17.5847 29.7486 17.5847 29.0426C17.5848 15.6623 28.4436 4.80336 41.824 4.80334ZM29.1833 38.9938C27.0481 38.9938 25.3171 41.1619 25.3171 43.8356C25.3173 46.5091 27.0482 48.6764 29.1833 48.6764C31.3184 48.6763 33.0494 46.509 33.0496 43.8356C33.0496 41.1619 31.3185 38.9939 29.1833 38.9938ZM55.0027 38.9938C52.8675 38.9938 51.1365 41.1619 51.1365 43.8356C51.1366 46.5091 52.8676 48.6763 55.0027 48.6764C57.1378 48.6764 58.8687 46.5091 58.8689 43.8356C58.8689 41.1619 57.1379 38.9938 55.0027 38.9938Z'/%3E%3C/svg%3E">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Roboto for a Google-like feel -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa; /* Google grey background */
        }
        pre, code {
            font-family: 'Roboto Mono', monospace;
        }
        .session-card {
            transition: all 0.2s ease-in-out;
        }
        .session-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Custom scrollbar for activity lists */
        .activity-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .activity-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .activity-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .activity-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800 flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-sm z-10 flex-none">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <!-- Dashboard Logo -->
                <div class="w-8 h-8 bg-[#715cd7] rounded-lg flex items-center justify-center text-white p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 84 91" fill="currentColor">
                        <path d="M41.824 4.80334C55.2044 4.80334 66.0631 15.6622 66.0632 29.0426C66.0632 29.7486 66.0299 30.4552 65.9626 31.1276C65.9963 31.4636 66.0632 31.7999 66.0632 32.1696V51.6354C66.0632 52.7782 65.7946 53.8539 65.324 54.8287V74.4957C65.324 76.6137 67.0722 78.3619 69.1902 78.3619C71.2421 78.3619 72.9471 76.7212 73.0515 74.693L73.0613 74.2985C73.1659 72.2704 74.8708 70.6295 76.9226 70.6295C79.0405 70.6296 80.7886 72.3443 80.7888 74.4957C80.7888 80.6143 76.0149 85.5898 69.9636 86.027C69.7283 86.0606 69.4591 86.0944 69.1902 86.0944C68.9212 86.0944 68.6857 86.0942 68.4167 86.027C62.399 85.6235 57.5916 80.648 57.5916 74.4957V59.0309H52.4138V74.3619C52.4136 76.4798 50.6991 78.2281 48.5476 78.2281C46.4298 78.228 44.6816 76.5133 44.6814 74.3619V59.0309H39.5046V74.3619C39.5044 76.4797 37.7898 78.228 35.6384 78.2281C33.5205 78.2281 31.7724 76.5134 31.7722 74.3619V59.0309H26.5945V74.4957C26.5945 80.6143 21.787 85.6234 15.7693 86.027C15.534 86.0606 15.2648 86.0944 14.9958 86.0944C14.7269 86.0944 14.4913 86.0942 14.2224 86.027C8.20468 85.6234 3.39722 80.648 3.39722 74.4957C3.3974 72.3779 5.14552 70.6295 7.26343 70.6295C9.38133 70.6295 11.1295 72.3443 11.1296 74.4957C11.1296 76.6137 12.8779 78.3619 14.9958 78.3619C17.1139 78.3619 18.8621 76.6137 18.8621 74.4957V55.8033C18.0554 54.6268 17.5848 53.1816 17.5847 51.6354V32.1696C17.5847 31.7999 17.6517 31.4636 17.6853 31.1276C17.6181 30.4216 17.5847 29.7486 17.5847 29.0426C17.5848 15.6623 28.4436 4.80336 41.824 4.80334ZM29.1833 38.9938C27.0481 38.9938 25.3171 41.1619 25.3171 43.8356C25.3173 46.5091 27.0482 48.6764 29.1833 48.6764C31.3184 48.6763 33.0494 46.509 33.0496 43.8356C33.0496 41.1619 31.3185 38.9939 29.1833 38.9938ZM55.0027 38.9938C52.8675 38.9938 51.1365 41.1619 51.1365 43.8356C51.1366 46.5091 52.8676 48.6763 55.0027 48.6764C57.1378 48.6764 58.8687 46.5091 58.8689 43.8356C58.8689 41.1619 57.1379 38.9938 55.0027 38.9938Z" />
                    </svg>
                </div>
                <h1 class="text-xl font-medium text-gray-900 tracking-tight">Jules Dashboard</h1>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="fetchSessions()" class="text-gray-500 hover:text-blue-600 transition-colors focus:outline-none" title="Refresh Sessions" id="refreshBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-blue-600 transition-colors focus:outline-none" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto px-4 py-3 sm:px-6 sm:py-5 lg:px-8 lg:py-6 relative">
        <div class="max-w-5xl mx-auto space-y-4">
            
            <!-- Welcome / Empty State -->
            <div id="welcomeState" class="hidden text-center py-20">
                <div class="bg-blue-50 text-blue-700 p-4 rounded-full inline-block mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <h2 class="text-2xl font-semibold text-gray-900 mb-2">Welcome to Jules</h2>
                <p class="text-gray-600 mb-6 max-w-md mx-auto">Configure your API key in settings to start viewing your active coding sessions and agent activities.</p>
                <button onclick="toggleSettings()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md shadow-sm transition-colors">
                    Configure API Key
                </button>
            </div>

            <!-- Loading State -->
            <div id="mainLoader" class="hidden flex justify-center py-20">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
            </div>

            <!-- Error Banner -->
            <div id="errorBanner" class="hidden bg-red-50 border-l-4 border-red-500 p-4 mb-4 rounded-r shadow-sm">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700" id="errorText">Something went wrong.</p>
                        <button onclick="retryFetch()" class="text-sm font-medium text-red-700 hover:text-red-600 underline mt-1">Retry</button>
                    </div>
                </div>
            </div>

            <!-- Session List Container -->
            <div id="sessionList" class="grid grid-cols-1 gap-4">
                <!-- Sessions will be injected here -->
            </div>
            
            <!-- Load More -->
            <div id="loadMoreContainer" class="hidden text-center pt-4">
                <button onclick="fetchSessions(nextPageToken)" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium py-2 px-6 rounded-md shadow-sm transition-colors text-sm">
                    Load More Sessions
                </button>
            </div>

        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4 overflow-hidden transform transition-all scale-95">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-medium text-gray-900">Settings</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">Google Jules API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="Enter your API Key" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <p class="mt-2 text-xs text-gray-500">
                        Your key is stored locally in your browser. Get your key from the <a href="https://console.cloud.google.com" target="_blank" class="text-blue-600 hover:underline">Google Cloud Console</a> or Jules Settings.
                    </p>
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition-colors text-sm">
                        Save & Connect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- State Management ---
        const CONFIG = {
            baseUrl: 'https://jules.googleapis.com/v1alpha', // Based on publicly available info
            localStorageKey: 'jules_api_key'
        };

        let state = {
            sessions: [],
            nextPageToken: null,
            expandedSessionId: null
        };

        // --- DOM Elements ---
        const els = {
            settingsModal: document.getElementById('settingsModal'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            sessionList: document.getElementById('sessionList'),
            welcomeState: document.getElementById('welcomeState'),
            mainLoader: document.getElementById('mainLoader'),
            errorBanner: document.getElementById('errorBanner'),
            errorText: document.getElementById('errorText'),
            loadMoreContainer: document.getElementById('loadMoreContainer'),
            refreshBtn: document.getElementById('refreshBtn')
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const storedKey = localStorage.getItem(CONFIG.localStorageKey);
            if (storedKey) {
                els.apiKeyInput.value = storedKey;
                fetchSessions();
            } else {
                els.welcomeState.classList.remove('hidden');
            }
        });

        // --- Settings Logic ---
        function toggleSettings() {
            const modal = els.settingsModal;
            const isHidden = modal.classList.contains('hidden');
            
            if (isHidden) {
                modal.classList.remove('hidden');
                // Small timeout to allow display:block to apply before opacity transition
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('div').classList.remove('scale-95');
                    modal.querySelector('div').classList.add('scale-100');
                }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.remove('scale-100');
                modal.querySelector('div').classList.add('scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 200);
            }
        }

        function saveSettings() {
            const key = els.apiKeyInput.value.trim();
            if (!key) {
                alert('Please enter a valid API key.');
                return;
            }
            localStorage.setItem(CONFIG.localStorageKey, key);
            toggleSettings();
            
            // Reset state and fetch
            state.sessions = [];
            state.nextPageToken = null;
            els.sessionList.innerHTML = '';
            fetchSessions();
        }

        // --- API Logic ---
        function getAuthHeaders() {
            const key = localStorage.getItem(CONFIG.localStorageKey);
            return {
                'Content-Type': 'application/json',
                'X-Goog-Api-Key': key
            };
        }

        async function fetchSessions(pageToken = null) {
            hideError();
            console.log(`Fetching sessions... ${pageToken ? '(next page)' : ''}`);
            
            // UI State updates
            if (!pageToken) {
                els.mainLoader.classList.remove('hidden');
                els.refreshBtn?.classList.add('animate-spin');
                els.welcomeState.classList.add('hidden');
                els.sessionList.innerHTML = ''; 
            } else {
                // Show small loader on load more button? handled by async await pattern mostly
            }

            try {
                const url = new URL(`${CONFIG.baseUrl}/sessions`);
                url.searchParams.append('pageSize', '20');
                if (pageToken) url.searchParams.append('pageToken', pageToken);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`Fetched ${data.sessions?.length || 0} sessions.`);
                
                // Update State
                if (data.sessions) {
                    state.sessions = pageToken ? [...state.sessions, ...data.sessions] : data.sessions;
                }
                state.nextPageToken = data.nextPageToken || null;

                renderSessions(data.sessions || [], pageToken !== null); // Append if paginating
                
            } catch (err) {
                console.error(err);
                showError(err.message);
            } finally {
                els.mainLoader.classList.add('hidden');
                els.refreshBtn?.classList.remove('animate-spin');
            }
        }

        async function fetchActivities(sessionName, containerId, mode = 'recent', isLoadMore = false) {
            console.log(`Loading activities for ${sessionName} (Mode: ${mode}, LoadMore: ${isLoadMore})...`);
            
            // Init state if needed
            if (!window.activityStates) window.activityStates = {};
            if (!window.activityStates[sessionName]) {
                window.activityStates[sessionName] = { nextPageToken: null, mode: 'recent' };
            }
            const activityState = window.activityStates[sessionName];

            const container = document.getElementById(containerId);
            const contentDiv = container.querySelector('.activities-content');
            const loader = container.querySelector('.loader-container');
            const loadMoreBtn = container.querySelector('.load-more-activities');
            const loadTrigger = container.querySelector('.load-trigger');
            
            // UI Setup
            if (!isLoadMore) {
                // Initial load: clear and show loader
                contentDiv.innerHTML = '';
                contentDiv.classList.add('hidden');
                if (loadTrigger) loadTrigger.classList.add('hidden');
                loader.classList.remove('hidden');
                loadMoreBtn.classList.add('hidden');
            } else {
                // Loading more: disable button temporarily
                const btn = loadMoreBtn.querySelector('button');
                if(btn) { btn.disabled = true; btn.textContent = 'Loading...'; }
            }

            try {
                let itemsToRender = [];
                
                if (mode === 'recent') {
                    // --- Existing "Recent 10" Logic ---
                    let pageToken = null;
                    let tailBuffer = [];
                    const MAX_DISPLAY = 10;
                    let totalCount = 0;

                    do {
                        const url = new URL(`${CONFIG.baseUrl}/${sessionName}/activities`);
                        url.searchParams.append('pageSize', '100'); // Large page size for traversal
                        if (pageToken) url.searchParams.append('pageToken', pageToken);

                        const response = await fetch(url, { method: 'GET', headers: getAuthHeaders() });
                        if (!response.ok) throw new Error('Failed to load activities');
                        const data = await response.json();
                        
                        const pageActivities = data.activities || [];
                        totalCount += pageActivities.length;
                        
                        if (pageActivities.length > 0) {
                            tailBuffer = tailBuffer.concat(pageActivities);
                            if (tailBuffer.length > MAX_DISPLAY) {
                                tailBuffer = tailBuffer.slice(-MAX_DISPLAY);
                            }
                        }
                        pageToken = data.nextPageToken;
                    } while (pageToken);
                    
                    itemsToRender = tailBuffer;
                    console.log(`Recent Mode: Found ${totalCount} total. Displaying last ${tailBuffer.length}.`);
                    
                } else {
                    // --- "All" Logic (Forward Pagination) ---
                    const url = new URL(`${CONFIG.baseUrl}/${sessionName}/activities`);
                    url.searchParams.append('pageSize', '15');
                    
                    // Use stored token if loading more, otherwise start fresh (null)
                    // If isLoadMore is false, we are resetting, so use null. 
                    const tokenToUse = isLoadMore ? activityState.nextPageToken : null;
                    if (tokenToUse) url.searchParams.append('pageToken', tokenToUse);

                    const response = await fetch(url, { method: 'GET', headers: getAuthHeaders() });
                    if (!response.ok) throw new Error('Failed to load activities');
                    const data = await response.json();
                    
                    itemsToRender = data.activities || [];
                    activityState.nextPageToken = data.nextPageToken || null;
                    
                    console.log(`All Mode: Fetched ${itemsToRender.length} items. Next page? ${!!activityState.nextPageToken}`);
                }

                // Render
                const html = generateActivitiesHtml(itemsToRender); 
                
                if (isLoadMore) {
                    const prevCount = contentDiv.children.length;
                    contentDiv.insertAdjacentHTML('beforeend', html);
                    const firstNew = contentDiv.children[prevCount];
                    if (firstNew) {
                        // Small timeout to ensure DOM update
                        setTimeout(() => firstNew.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
                    }
                } else {
                    contentDiv.innerHTML = itemsToRender.length > 0 ? html : '<p class="text-gray-500 text-sm text-center italic py-2">No activities recorded.</p>';
                }
                
                contentDiv.classList.remove('hidden');

                // Handle Load More visibility (Only for 'all' mode)
                if (mode === 'all' && activityState.nextPageToken) {
                    loadMoreBtn.classList.remove('hidden');
                    const btn = loadMoreBtn.querySelector('button');
                    if(btn) { btn.disabled = false; btn.textContent = 'Load next 15...'; }
                } else {
                    loadMoreBtn.classList.add('hidden');
                }

            } catch (err) {
                console.error(err);
                if (!isLoadMore) {
                    contentDiv.innerHTML = `<p class="text-red-500 text-sm py-2">Error loading activities: ${err.message}</p>`;
                    contentDiv.classList.remove('hidden');
                } else {
                   alert(`Error loading more: ${err.message}`);
                   const btn = loadMoreBtn.querySelector('button');
                   if(btn) { btn.disabled = false; btn.textContent = 'Load next 15...'; }
                }
            } finally {
                if (!isLoadMore) loader.classList.add('hidden');
            }
        }

        // New Helper Functions
        function setActivityMode(sessionName, containerId, mode) {
            // Update UI buttons
            const container = document.getElementById(containerId);
            const btns = container.querySelectorAll('.mode-btn');
            btns.forEach(btn => {
                if (btn.dataset.mode === mode) {
                    btn.className = 'mode-btn px-3 py-1 text-xs rounded-md font-medium bg-blue-50 text-blue-600 shadow-sm transition-all';
                } else {
                    btn.className = 'mode-btn px-3 py-1 text-xs rounded-md font-medium text-gray-500 hover:text-gray-700 transition-all';
                }
            });

            // Update State
            if (!window.activityStates) window.activityStates = {};
            if (!window.activityStates[sessionName]) window.activityStates[sessionName] = {};
            window.activityStates[sessionName].mode = mode;
            window.activityStates[sessionName].nextPageToken = null; // Reset pagination

            // Fetch
            fetchActivities(sessionName, containerId, mode, false);
        }

        function loadMoreActivities(sessionName, containerId) {
            fetchActivities(sessionName, containerId, 'all', true);
        }

        function triggerInitialLoad(sessionName, containerId) {
             const mode = window.activityStates?.[sessionName]?.mode || 'recent';
             fetchActivities(sessionName, containerId, mode, false);
        }

        function retryFetch() {
            fetchSessions();
        }

        async function sendMessage(sessionName, sessionId) {
            const txtInput = document.getElementById(`msg-${sessionId}`);
            const btn = document.getElementById(`btn-${sessionId}`);
            const statusDiv = document.getElementById(`status-${sessionId}`);
            const message = txtInput.value.trim();

            if (!message) return;

            // UI Loading State
            txtInput.disabled = true;
            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending...`;
            statusDiv.innerHTML = '';

            try {
                const url = new URL(`${CONFIG.baseUrl}/${sessionName}:sendMessage`);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ userMessage: message })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error?.message || `API Error: ${response.status}`);
                }

                // Success: Option B (Append locally)
                statusDiv.innerHTML = '<span class="text-green-600 font-medium">Message sent!</span>';

                // Construct local activity
                const mockActivity = {
                    userMessaged: { userMessage: message },
                    createTime: new Date().toISOString(),
                    originator: 'USER' // Heuristic for rendering
                };

                const html = generateActivitiesHtml([mockActivity]);
                const containerId = `activities-${sessionId}`;
                const contentDiv = document.querySelector(`#${containerId} .activities-content`);

                contentDiv.insertAdjacentHTML('beforeend', html);

                // Scroll to bottom
                setTimeout(() => {
                    contentDiv.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 100);

                // Reset Input
                txtInput.value = '';

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = `<span class="text-red-600 font-medium">Error: ${escapeHtml(err.message)}</span>`;
            } finally {
                // Restore UI
                txtInput.disabled = false;
                btn.disabled = false;
                btn.innerText = 'Send';
            }
        }

        // --- Rendering Logic ---
        function renderSessions(sessions, append) {
            if (!sessions || sessions.length === 0) {
                if (!append) els.sessionList.innerHTML = '<div class="text-center text-gray-500 py-10">No sessions found.</div>';
                return;
            }

            const html = sessions.map(session => {
                const sessionId = session.id || session.name.split('/').pop();
                const containerId = `activities-${sessionId}`;
                const createdDate = session.createTime ? new Date(session.createTime).toLocaleString() : 'N/A';
                const updatedDate = session.updateTime ? new Date(session.updateTime).toLocaleString() : 'N/A';
                const repoSource = session.sourceContext?.source?.replace('sources/github/', '') || 'N/A';
                const pr = session.outputs?.find(o => o.pullRequest)?.pullRequest;
                const statusColor = getStatusColor(session.state);

                // Use a default title if none exists, or prompt excerpt
                const title = session.title || session.prompt || 'Untitled Session';
                const prompt = session.prompt || 'No description provided';
                const repoUrl = repoSource !== 'N/A' ? `https://github.com/${repoSource}` : '#';

                return `
                    <div class="session-card bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="p-5">
                            <div class="flex flex-wrap items-start justify-between gap-2 mb-1">
                                <h3 class="text-lg font-semibold text-gray-900 truncate flex-1 min-w-[200px]" title="${title}">${title}</h3>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold tracking-wider uppercase flex-none ${statusColor}">
                                    ${session.state || 'ACTIVE'}
                                </span>
                            </div>

                            <!-- Repo Info -->
                            <div class="flex items-center gap-1.5 text-xs text-gray-500 mb-3 font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
                                </svg>
                                <a href="${repoUrl}" target="_blank" class="truncate hover:text-blue-600 transition-colors hover:underline" title="View Repository">${repoSource}</a>
                            </div>

                            <p class="text-gray-600 text-sm mb-4 line-clamp-2 cursor-pointer" onclick="this.classList.toggle('line-clamp-2')" title="Click to expand/collapse">${prompt}</p>
                            
                            ${pr ? `
                            <div class="mb-4">
                                <a href="${pr.url}" target="_blank" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-green-50 text-green-700 rounded-md text-[11px] font-semibold hover:bg-green-100 transition-colors border border-green-100 w-full md:w-auto">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 640 640"><!--!Font Awesome Free v7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M392 88C392 78.3 386.2 69.5 377.2 65.8C368.2 62.1 357.9 64.2 351 71L295 127C285.6 136.4 285.6 151.6 295 160.9L351 216.9C357.9 223.8 368.2 225.8 377.2 222.1C386.2 218.4 392 209.7 392 200L392 176L416 176C433.7 176 448 190.3 448 208L448 422.7C419.7 435 400 463.2 400 496C400 540.2 435.8 576 480 576C524.2 576 560 540.2 560 496C560 463.2 540.3 435 512 422.7L512 208C512 155 469 112 416 112L392 112L392 88zM136 144C136 130.7 146.7 120 160 120C173.3 120 184 130.7 184 144C184 157.3 173.3 168 160 168C146.7 168 136 157.3 136 144zM192 217.3C220.3 205 240 176.8 240 144C240 99.8 204.2 64 160 64C115.8 64 80 99.8 80 144C80 176.8 99.7 205 128 217.3L128 422.6C99.7 434.9 80 463.1 80 495.9C80 540.1 115.8 575.9 160 575.9C204.2 575.9 240 540.1 240 495.9C240 463.1 220.3 434.9 192 422.6L192 217.3zM136 496C136 482.7 146.7 472 160 472C173.3 472 184 482.7 184 496C184 509.3 173.3 520 160 520C146.7 520 136 509.3 136 496zM480 472C493.3 472 504 482.7 504 496C504 509.3 493.3 520 480 520C466.7 520 456 509.3 456 496C456 482.7 466.7 472 480 472z"/></svg>
                                    PR: ${pr.title}
                                </a>
                            </div>
                            ` : ''}

                            <div class="flex items-center justify-between mt-4 border-t border-gray-100 pt-3">
                                <div class="flex items-center gap-3 min-w-0">
                                    <a href="${session.url}" target="_blank" class="text-xs text-gray-400 font-mono hover:text-blue-600 transition-colors flex items-center gap-1 flex-none" title="Open in Jules">
                                        ${sessionId}
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                        </svg>
                                    </a>
                                    <div class="text-[10px] text-gray-400 truncate border-l border-gray-200 pl-3 hidden md:block" title="Created: ${createdDate} | Updated: ${updatedDate}">
                                        <span class="font-medium text-gray-400">C:</span> ${createdDate} <span class="mx-1 text-gray-300">â€¢</span> <span class="font-medium text-gray-400">U:</span> ${updatedDate}
                                    </div>
                                </div>
                                <button onclick="toggleActivities('${session.name}', '${containerId}', this)" 
                                    class="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors focus:outline-none group">
                                    <span>View Activities</span>
                                    <svg class="ml-1 h-4 w-4 transform transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Activities Panel (Hidden by default) -->
                        <div id="${containerId}" class="hidden bg-gray-50 border-t border-gray-200">
                            <div class="p-4">
                                <!-- Toolbar -->
                                <div class="flex justify-between items-center mb-3 px-1">
                                    <div class="text-xs font-medium text-gray-500">Activity Log</div>
                                    <div class="flex bg-white rounded-lg border border-gray-200 p-0.5">
                                        <button data-mode="recent" onclick="setActivityMode('${session.name}', '${containerId}', 'recent')" class="mode-btn px-3 py-1 text-xs rounded-md font-medium bg-blue-50 text-blue-600 shadow-sm transition-all">Recent 10</button>
                                        <button data-mode="all" onclick="setActivityMode('${session.name}', '${containerId}', 'all')" class="mode-btn px-3 py-1 text-xs rounded-md font-medium text-gray-500 hover:text-gray-700 transition-all">All</button>
                                    </div>
                                </div>

                                <div class="load-trigger text-center py-6">
                                    <p class="text-gray-400 text-xs mb-3">Content hidden to save data</p>
                                    <button onclick="triggerInitialLoad('${session.name}', '${containerId}')" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium py-1.5 px-4 rounded shadow-sm transition-colors text-xs">
                                        Load Activities
                                    </button>
                                </div>

                                <div class="loader-container hidden flex items-center justify-center py-4"><div class="loader"></div></div>
                                <div class="activities-content space-y-4 max-h-[600px] overflow-y-auto activity-scroll pr-2">
                                    <!-- Activities injected here -->
                                </div>
                                <div class="load-more-activities hidden text-center mt-3 border-t border-gray-200 pt-3">
                                    <button onclick="loadMoreActivities('${session.name}', '${containerId}')" class="text-xs bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 font-medium py-1.5 px-4 rounded shadow-sm transition-colors">Load next 15...</button>
                                </div>

                                <!-- Send Message Input -->
                                <div class="mt-4 border-t border-gray-200 pt-4">
                                    <label for="msg-${sessionId}" class="block text-xs font-medium text-gray-700 mb-2">Send Message to Jules</label>
                                    <div class="relative rounded-md shadow-sm">
                                        <textarea id="msg-${sessionId}" rows="3" class="shadow-sm block w-full focus:ring-blue-500 focus:border-blue-500 sm:text-sm border border-gray-300 rounded-md" placeholder="Type your message here..."></textarea>
                                    </div>
                                    <div class="mt-2 flex items-center justify-between">
                                        <div id="status-${sessionId}" class="text-xs"></div>
                                        <button onclick="sendMessage('${session.name}', '${sessionId}')" id="btn-${sessionId}" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                            Send
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            if (append) {
                els.sessionList.insertAdjacentHTML('beforeend', html);
            } else {
                els.sessionList.innerHTML = html;
            }

            // Handle Load More Button
            if (state.nextPageToken) {
                els.loadMoreContainer.classList.remove('hidden');
            } else {
                els.loadMoreContainer.classList.add('hidden');
            }
        }

        // --- Activity Rendering Implementation ---
        
        function generateActivitiesHtml(activities) {
            return activities.map(activity => {
                const originator = activity.originator || 'system';
                const isUser = originator.toLowerCase() === 'user';
                const timeStr = activity.createTime ? new Date(activity.createTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';

                // Determine content based on union fields
                let contentHtml = '';
                let typeLabel = '';
                
                if (activity.userMessaged) {
                    typeLabel = 'User Message';
                    contentHtml = `<p class="whitespace-pre-wrap">${escapeHtml(activity.userMessaged.userMessage)}</p>`;
                } else if (activity.agentMessaged) {
                    typeLabel = 'Agent Message';
                    contentHtml = `<p class="whitespace-pre-wrap">${renderMarkdownLite(activity.agentMessaged.agentMessage)}</p>`;
                } else if (activity.planGenerated) {
                    typeLabel = 'Plan Generated';
                    contentHtml = renderPlan(activity.planGenerated.plan);
                } else if (activity.planApproved) {
                    typeLabel = 'Plan Approved';
                    contentHtml = `<div class="flex items-center text-green-700 bg-green-50 p-2 rounded border border-green-200">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        Plan Approved: <span class="font-mono ml-1 text-xs">${activity.planApproved.planId}</span>
                    </div>`;
                } else if (activity.progressUpdated) {
                    typeLabel = 'Progress Update';
                    // Skip empty progress updates
                    if (activity.progressUpdated.title || activity.progressUpdated.description) {
                        contentHtml = `
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-3">
                                ${activity.progressUpdated.title ? `<p class="font-medium text-blue-900">${escapeHtml(activity.progressUpdated.title)}</p>` : ''}
                                ${activity.progressUpdated.description ? `<p class="text-sm text-blue-700 mt-1">${renderMarkdownLite(activity.progressUpdated.description)}</p>` : ''}
                            </div>`;
                    }
                } else if (activity.sessionCompleted) {
                    typeLabel = 'Session Completed';
                    contentHtml = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Session Ended</span>`;
                } else if (activity.sessionFailed) {
                    typeLabel = 'Session Failed';
                    contentHtml = `<div class="text-red-600 font-medium">Failed: ${escapeHtml(activity.sessionFailed.reason)}</div>`;
                } else {
                    // Fallback for unknown types
                    typeLabel = 'Activity';
                    contentHtml = `<pre class="text-xs text-gray-500 overflow-x-auto">${JSON.stringify(activity, null, 2)}</pre>`;
                }

                // Render Artifacts if present
                if (activity.artifacts && activity.artifacts.length > 0) {
                    contentHtml += `<div class="mt-2 space-y-2">
                        ${activity.artifacts.map(renderArtifact).join('')}
                    </div>`;
                }

                // Layout
                return `
                    <div class="flex gap-3 group">
                        <div class="flex-none flex flex-col items-center">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center ${isUser ? 'bg-blue-100 text-blue-600' : 'bg-purple-100 text-purple-600'} mt-1">
                                <span class="text-xs font-bold">${isUser ? 'U' : 'A'}</span>
                            </div>
                            <div class="w-0.5 bg-gray-100 flex-1 h-full my-1 group-last:hidden"></div>
                        </div>
                        <div class="pb-6 flex-1 min-w-0">
                            <div class="flex items-baseline justify-between mb-1">
                                <span class="text-xs font-bold ${isUser ? 'text-blue-600' : 'text-purple-600'} uppercase tracking-wide">${typeLabel}</span>
                                <span class="text-xs text-gray-400 font-mono">${timeStr}</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm text-sm text-gray-700">
                                ${contentHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPlan(plan) {
            if (!plan || !plan.steps) return '<span class="text-gray-500 italic">Empty Plan</span>';
            return `
                <div class="space-y-2">
                    ${plan.steps.map((step, idx) => `
                        <div class="flex gap-2">
                            <div class="flex-none w-5 h-5 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center text-xs font-mono">${idx + 1}</div>
                            <div>
                                <p class="font-medium text-gray-900">${escapeHtml(step.title)}</p>
                                <p class="text-gray-500 text-xs">${renderMarkdownLite(step.description)}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderArtifact(artifact) {
            if (artifact.bashOutput) {
                const bash = artifact.bashOutput;
                const isErr = bash.exitCode !== 0;
                return `
                    <div class="bg-gray-900 rounded-md overflow-hidden text-xs font-mono">
                        <div class="bg-gray-800 px-3 py-1 text-gray-400 flex justify-between border-b border-gray-700">
                            <span>$ ${escapeHtml(bash.command)}</span>
                            <span class="${isErr ? 'text-red-400' : 'text-green-400'}">Exit: ${bash.exitCode}</span>
                        </div>
                        <div class="p-3 text-gray-300 whitespace-pre-wrap overflow-x-auto">${escapeHtml(bash.output)}</div>
                    </div>
                `;
            } else if (artifact.changeSet) {
                const cs = artifact.changeSet;
                const patch = cs.gitPatch?.unidiffPatch || '';
                
                // Store patch for download
                const patchId = 'patch_' + Math.random().toString(36).substr(2, 9);
                window.patchStorage[patchId] = patch;

                return `
                    <details class="border border-yellow-200 bg-yellow-50 rounded-md overflow-hidden group">
                        <summary class="flex items-center text-yellow-800 p-2 cursor-pointer hover:bg-yellow-100 transition-colors list-none outline-none">
                            <svg class="w-4 h-4 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            <span class="font-medium text-xs truncate flex-1 mr-2">Changes to ${escapeHtml(cs.source)}</span>
                            
                            <button onclick="downloadDiff(event, '${escapeHtml(cs.source)}', '${patchId}')" class="p-1 hover:bg-yellow-200 rounded text-yellow-700 mr-2" title="Download Diff">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            </button>
                            
                            <svg class="w-3 h-3 opacity-50 transform transition-transform group-open:rotate-180 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </summary>
                        <div class="p-2 pt-0 border-t border-yellow-100">
                            ${patch ? `<pre class="text-xs bg-white border border-gray-200 p-2 rounded overflow-x-auto max-h-80 mt-2">${escapeHtml(patch)}</pre>` : '<p class="text-xs italic text-yellow-600 mt-2">No diff available</p>'}
                        </div>
                    </details>
                `;
            } else if (artifact.media) {
                return `<div class="text-xs text-gray-500">[Media: ${artifact.media.mimeType}]</div>`;
            }
            return `<div class="text-xs text-gray-400">[Unknown Artifact]</div>`;
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderMarkdownLite(text) {
            if (!text) return '';
            // First escape HTML to be safe
            let html = escapeHtml(text);
            
            // Handle bold: **text** -> <strong>text</strong>
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Handle monospace: `text` -> <code ...>text</code>
            html = html.replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded text-[0.8em] font-mono text-blue-600">$1</code>');
            
            // Handle line breaks
            html = html.replace(/\n/g, '<br>');
            
            return html;
        }

        function toggleActivities(sessionName, containerId, btn) {
            const container = document.getElementById(containerId);
            const isHidden = container.classList.contains('hidden');
            const icon = btn.querySelector('svg');

            // Close others if you want accordion style (optional, currently independent)
            // document.querySelectorAll('[id^="activities-"]').forEach(el => el.classList.add('hidden'));

            if (isHidden) {
                container.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                container.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        function getStatusColor(state) {
            // Colors based on common session states
            switch (state) {
                case 'RUNNING':
                case 'ACTIVE': return 'bg-green-100 text-green-800';
                case 'COMPLETED': return 'bg-blue-100 text-blue-800';
                case 'FAILED': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function showError(msg) {
            els.errorText.textContent = msg;
            els.errorBanner.classList.remove('hidden');
        }

        function hideError() {
            els.errorBanner.classList.add('hidden');
        }

        // --- Diff Download Logic ---
        window.patchStorage = {};
        
        function downloadDiff(event, filename, patchId) {
            event.preventDefault();
            event.stopPropagation();
            
            const content = window.patchStorage[patchId];
            if (!content) {
                alert('Error: Patch content not found.');
                return;
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Ensure filename ends in .diff or .patch
            let safeName = filename.split('/').pop() || 'changes';
            if (!safeName.endsWith('.diff') && !safeName.endsWith('.patch')) {
                safeName += '.diff';
            }
            
            a.href = url;
            a.download = safeName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>
